{% extends "base.html" %}
{% block title %}Kid Dashboard{% endblock %}

{% block content %}
<div class="card" style="max-width:860px;margin:auto;">
  <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;">
    <h2 style="margin:0;">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ {{ kid.first_name }}! üëã</h2>
    <div style="font-weight:700;">‚≠ê ‡πÅ‡∏ï‡πâ‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì: <span style="font-size:1.1rem">{{ kid.points or 0 }}</span></div>
  </div>

  {% if not in_family %}
    <hr>
    <div style="text-align:center;margin-bottom:6px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß</div>
    <form method="post" action="{{ request.url_for('kid_join_family') }}" style="display:grid;gap:10px;max-width:520px;margin:0 auto;">
      <input type="hidden" name="kid_id" value="{{ kid.id }}">
      <label>‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß</label>
      <input name="family_code" placeholder="‡πÄ‡∏ä‡πà‡∏ô FAM-12AB9F" required>
      <button class="btn" type="submit">‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß</button>
    </form>
    <div style="margin-top:12px;text-align:center;color:#666">
      *‡∏Ç‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞
    </div>
    <hr>
  {% else %}
    {% if family_name %}
      <div style="margin-top:8px;color:#666;">‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô <b>{{ family_name }}</b></div>
    {% endif %}
  {% endif %}

  <div style="display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:8px;margin:18px 0;">
    <div class="pill" style="background:#fff7e6;border:1px solid #ffe7b8;">
      <div class="ms-3" style="font-size:0.9rem;color:#a56c00;">‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</div>
      <div class="ms-3" style="font-weight:800;font-size:1.3rem">{{ count_new or 0 }}</div>
    </div>
    <div class="pill" style="background:#eaf4ff;border:1px solid #cfe6ff;">
      <div class="ms-3" style="font-size:0.9rem;color:#0a5196;">‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à</div>
      <div class="ms-3" style="font-weight:800;font-size:1.3rem">{{ count_pending or 0 }}</div>
    </div>
    <div class="pill" style="background:#eaffef;border:1px solid #c2f0d2;">
      <div class="ms-3" style="font-size:0.9rem;color:#0e7a42;">‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</div>
      <div class="ms-3" style="font-weight:800;font-size:1.3rem">{{ count_done or 0 }}</div>
    </div>
  </div>

  {% if in_family %}
    <!-- ‡πÅ‡∏ó‡πá‡∏ö -->
    <div style="display:flex;gap:6px;justify-content:center;margin-bottom:12px;">
      <a href="#tasks" class="btn" onclick="showPane('pane-tasks');return false;">‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</a>
      <a href="#rewards" class="btn" onclick="showPane('pane-rewards');return false;">‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</a>
    </div>

    <!-- ‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à -->
    <div id="pane-tasks">
      {% if tasks and tasks|length > 0 %}
        <div style="display:grid;gap:12px;">
          {% for t in tasks %}
            <div class="pill" style="text-align:left">
              <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap;">
                <div>
                  <div style="font-weight:700">{{ t.title }}</div>
                  <div style="color:#666;font-size:0.9rem">{{ t.description }}</div>
                  <div style="margin-top:4px;color:#444;font-size:0.9rem">
                    ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: <b>{{ t.points }}</b> ¬∑ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: <b>{{ t.status_display }}</b> ¬∑ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠ {{ t.created_at }}
                  </div>
                </div>
                {% if t.status == 'assigned' or t.status == 'rejected' %}
                  <div><span class="pill" style="background:#fff;border:1px dashed #999;">‡∏™‡πà‡∏á‡πÑ‡∏î‡πâ</span></div>
                {% elif t.status == 'submitted' %}
                  <div><span class="pill" style="background:#eaf4ff;border:1px solid #cfe6ff;">‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à</span></div>
                {% elif t.status == 'approved' %}
                  <div><span class="pill" style="background:#eaffef;border:1px solid #c2f0d2;">‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</span></div>
                {% endif %}
              </div>

              {% if t.status in ['assigned','rejected'] %}
                <form method="post"
                      action="{{ request.url_for('kid_submit_task', task_id=t.id) }}"
                      enctype="multipart/form-data"
                      style="display:grid;gap:8px;margin-top:10px;">
                  <input type="hidden" name="kid_id" value="{{ kid.id }}">
                  <label>‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ô‡∏ö (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
                  <textarea name="note" rows="2" placeholder="‡πÄ‡∏•‡πà‡∏≤‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏™‡∏±‡∏Å‡∏´‡∏ô‡πà‡∏≠‡∏¢‚Ä¶"></textarea>
                  <label>‡∏£‡∏π‡∏õ/‡πÑ‡∏ü‡∏•‡πå‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</label>
                  <input type="file" name="evidence">
                  <button class="btn" type="submit">üì§ ‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô</button>
                </form>
              {% endif %}
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="empty">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</div>
      {% endif %}
    </div>

    <!-- ‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏• -->
    <div id="pane-rewards" style="display:none;">

  {% if pending_rewards and pending_rewards|length > 0 %}
    <div class="pill" style="background:#fff7e6;border:1px solid #ffe7b8;">
      <div style="font-weight:800;margin-bottom:6px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</div>
      <div style="display:grid;gap:10px;">
        {% for pr in pending_rewards %}
          <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
            {% if pr.image_path %}
              <img src="/{{ pr.image_path }}" alt="reward"
                   style="width:70px;height:70px;object-fit:cover;border-radius:8px;border:1px solid #eee;">
            {% endif %}
            <div style="flex:1;">
              <div style="font-weight:700">{{ pr.name }}</div>
              <div class="muted" style="font-size:0.9rem;">
                ‡πÅ‡∏ï‡πâ‡∏°‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ: <b>{{ pr.cost }}</b> ¬∑ ‡∏Ç‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠ {{ pr.requested_at }}
              </div>
            </div>
            <button class="btn" type="button" disabled style="opacity:.6;cursor:not-allowed;">
              üïí ‡∏£‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
            </button>
          </div>
        {% endfor %}
      </div>
    </div>
    <div style="height:10px;"></div>
  {% endif %}

  {% if rewards and rewards|length > 0 %}
    <div style="display:grid;gap:12px;">
      {% for r in rewards %}
        <div class="pill" style="text-align:left">
          {% if r.image_path %}
            <img src="/{{ r.image_path }}" alt="reward image"
                 style="width:100%;max-height:200px;object-fit:cover;border-radius:8px;margin-bottom:8px;">
          {% endif %}
          <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap;">
            <div>
              <div style="font-weight:700">{{ r.name }}</div>
              <div style="color:#666;font-size:0.9rem">{{ r.description }}</div>
              <div style="margin-top:4px;color:#444;font-size:0.9rem">
                ‡∏£‡∏≤‡∏Ñ‡∏≤‡πÅ‡∏•‡∏Å: <b>{{ r.cost }}</b> ‡πÅ‡∏ï‡πâ‡∏°
              </div>
            </div>
            <form method="post" action="/kid/redeem/{{ r.id }}" style="margin:0;">
              <input type="hidden" name="kid_id" value="{{ kid.id }}">
              <button class="btn" type="submit">üõí ‡πÅ‡∏•‡∏Å‡πÄ‡∏•‡∏¢!</button>
            </form>
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="empty">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡πÉ‡∏´‡πâ‡πÅ‡∏•‡∏Å</div>
  {% endif %}
</div>

  {% endif %}
  
  <div style="margin-top:18px;text-align:center;">
    <a class="btn btn-outline-primary mb-2" href="{{ request.url_for('kid_history_page', kid_id=kid.id) }}">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</a>
    <hr>
    <a class="btn mt-2" href="/login">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</a>
  </div>
</div>

<script>
  function showPane(id) {
    document.getElementById('pane-tasks').style.display = (id === 'pane-tasks') ? '' : 'none';
    document.getElementById('pane-rewards').style.display = (id === 'pane-rewards') ? '' : 'none';
  }
</script>
{% endblock %}