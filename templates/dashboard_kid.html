{% extends "base.html" %}
{% block title %}Kid Dashboard{% endblock %}

{% block content %}

<div class="card" style="max-width:860px;margin:auto;">
  <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;">
    <h2 style="margin:0;">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ {{ kid.first_name }}! üëã</h2>
    <div style="font-weight:700;">‚≠ê ‡πÅ‡∏ï‡πâ‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì: <span style="font-size:1.1rem">{{ kid.points or 0 }}</span></div>
  </div>

  {% if not in_family %}
    <hr>
    <div style="text-align:center;margin-bottom:6px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß</div>
    <form method="post" action="/kid/join-family" style="display:grid;gap:10px;max-width:520px;margin:0 auto;">
      <input type="hidden" name="kid_id" value="{{ kid.id }}">
      <label>‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß</label>
      <input name="family_code" placeholder="‡πÄ‡∏ä‡πà‡∏ô FAM-12AB9F" required>
      <button class="btn" type="submit">‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß</button>
    </form>
    <div style="margin-top:12px;text-align:center;color:#666">
      *‡∏Ç‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞
    </div>
    <hr>
  {% else %}
    {% if family_name %}
      <div style="margin-top:8px;color:#666;">‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô <b>{{ family_name }}</b></div>
    {% endif %}
  {% endif %}

  <div style="display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:8px;margin:18px 0;">
    <div class="pill" style="background:#fff7e6;border:1px solid #ffe7b8;">
      <div style="font-size:0.9rem;color:#a56c00;">‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</div>
      <div style="font-weight:800;font-size:1.3rem">{{ count_new or 0 }}</div>
    </div>
    <div class="pill" style="background:#eaf4ff;border:1px solid #cfe6ff;">
      <div style="font-size:0.9rem;color:#0a5196;">‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à</div>
      <div style="font-weight:800;font-size:1.3rem">{{ count_pending or 0 }}</div>
    </div>
    <div class="pill" style="background:#eaffef;border:1px solid #c2f0d2;">
      <div style="font-size:0.9rem;color:#0e7a42;">‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</div>
      <div style="font-weight:800;font-size:1.3rem">{{ count_done or 0 }}</div>
    </div>
  </div>

  {% if in_family %}
    <!-- ‡πÅ‡∏ó‡πá‡∏ö‡∏á‡πà‡∏≤‡∏¢ ‡πÜ -->
    <div style="display:flex;gap:6px;justify-content:center;margin-bottom:12px;">
      <a href="#tasks" class="btn" onclick="showPane('pane-tasks');return false;">‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</a>
      <a href="#rewards" class="btn" onclick="showPane('pane-rewards');return false;">‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</a>
    </div>

    <!-- ‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô -->
    <div id="pane-tasks">
      {% if tasks and tasks|length > 0 %}
        <div style="display:grid;gap:12px;">
          {% for t in tasks %}
            <div class="pill" style="text-align:left">
              <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap;">
                <div>
                  <div style="font-weight:700">{{ t.title }}</div>
                  <div style="color:#666;font-size:0.9rem">{{ t.description }}</div>
                  <div style="margin-top:4px;color:#444;font-size:0.9rem">
                    ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: <b>{{ t.points }}</b> ¬∑ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: <b>{{ t.status_display }}</b> ¬∑ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠ {{ t.created_at }}
                  </div>
                </div>
                {% if t.status == 'assigned' or t.status == 'rejected' %}
                  <div><span class="pill" style="background:#fff;border:1px dashed #999;">‡∏™‡πà‡∏á‡πÑ‡∏î‡πâ</span></div>
                {% elif t.status == 'submitted' %}
                  <div><span class="pill" style="background:#eaf4ff;border:1px solid #cfe6ff;">‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à</span></div>
                {% elif t.status == 'done' %}
                  <div><span class="pill" style="background:#eaffef;border:1px solid #c2f0d2;">‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</span></div>
                {% endif %}
              </div>

              {% if t.status in ['assigned','rejected'] %}
                <form method="post" action="/kid/submit/{{ t.id }}" enctype="multipart/form-data"
                      style="display:grid;gap:8px;margin-top:10px;">
                  <input type="hidden" name="kid_id" value="{{ kid.id }}">
                  <label>‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ô‡∏ö (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
                  <textarea name="note" rows="2" placeholder="‡πÄ‡∏•‡πà‡∏≤‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏™‡∏±‡∏Å‡∏´‡∏ô‡πà‡∏≠‡∏¢‚Ä¶"></textarea>

                  <label>‡∏£‡∏π‡∏õ/‡πÑ‡∏ü‡∏•‡πå‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</label>
                  <input type="file" name="evidence">

                  <button class="btn" type="submit">üì§ ‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô</button>
                </form>
              {% endif %}
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="empty">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</div>
      {% endif %}
    </div>

    <!-- ‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏• -->
    <div id="pane-rewards" style="display:none;">
      {% if rewards and rewards|length > 0 %}
        <div style="display:grid;gap:12px;">
          {% for r in rewards %}
            <div class="pill" style="text-align:left">
              <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap;">
                <div>
                  <div style="font-weight:700">{{ r.name }}</div>
                  <div style="color:#666;font-size:0.9rem">{{ r.description }}</div>
                  <div style="margin-top:4px;color:#444;font-size:0.9rem">
                    ‡∏£‡∏≤‡∏Ñ‡∏≤‡πÅ‡∏•‡∏Å: <b>{{ r.cost }}</b> ‡πÅ‡∏ï‡πâ‡∏°
                    {% if r.remaining is not none %}
                      ¬∑ ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: <b>{{ r.remaining }}</b>
                    {% endif %}
                  </div>
                </div>
                <form method="post" action="/kid/redeem/{{ r.id }}" style="margin:0;">
                  <input type="hidden" name="kid_id" value="{{ kid.id }}">
                  <button class="btn" type="submit">üõí ‡πÅ‡∏•‡∏Å‡πÄ‡∏•‡∏¢!</button>
                </form>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="empty">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡πÉ‡∏´‡πâ‡πÅ‡∏•‡∏Å</div>
      {% endif %}
    </div>
  {% endif %}

  <div style="margin-top:18px;text-align:center;">
    <a class="btn" href="/login">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</a>
  </div>
</div>

<script>
  function showPane(id) {
    document.getElementById('pane-tasks').style.display = (id === 'pane-tasks') ? '' : 'none';
    document.getElementById('pane-rewards').style.display = (id === 'pane-rewards') ? '' : 'none';
  }
</script>

{% endblock %}
